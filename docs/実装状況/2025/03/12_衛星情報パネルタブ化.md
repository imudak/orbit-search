# 衛星情報パネルのタブ化実装

## 概要
衛星情報パネルがウィンドウとして表示されていた実装を、デモ画面と同様にタブ内に表示されるように修正しました。

## 変更内容
1. SatelliteInfoPanelコンポーネントからウィンドウ関連のプロパティと機能を削除
   - position、getPositionStyle、onCloseなどのプロパティを削除
   - ウィンドウの位置計算ロジックを削除

2. ウィンドウのようなスタイルを削除し、タブパネル内に自然に表示されるようにスタイル変更
   - Paper、Collapseコンポーネントを削除
   - タブパネル内に適したスタイリングに変更

3. ヘッダー部分を「タイトル部分」に変更し、閉じるボタンを削除
   - ウィンドウのヘッダーからタブ内のタイトルに変更
   - 閉じるボタンを削除（タブ内では不要）

4. 重複するスクロール可能なコンテンツエリアを削除
   - タブパネル自体がスクロール機能を持つため、重複するスクロールエリアを削除

5. PaperとCollapseの終了タグを削除
   - ウィンドウ表示に関連するコンポーネントを削除

## 動作確認
- 情報タブをクリックすると、SatelliteInfoPanelがタブパネル内に適切に表示されることを確認
- 観測地点情報、凡例情報などが正しく表示されることを確認
- タブ内表示になったことで、UIの一貫性が向上

## 今後の課題
- 衛星選択時の情報表示の改善
- タブ内での情報の整理と表示の最適化

## 発生したエラーと対応方針

### 1. 無限ループエラー

実装中に以下のエラーが発生しました：

```
Warning: Maximum update depth exceeded. This can happen when a component calls setState inside useEffect, but useEffect either doesn't have a dependency array, or one of the dependencies changes on every render.
    at SatelliteAnimationLayer (http://localhost:5173/src/components/Map/layers/SatelliteAnimationLayer.tsx:22:3)
```

このエラーは、SatelliteAnimationLayerコンポーネントのuseEffectの依存配列に問題があることを示しています。具体的には、satelliteIconが依存配列に含まれていますが、これはコンポーネントの関数内で毎回新しく作成されるため、レンダリングのたびに変更され、無限ループが発生しています。

#### 修正方針
1. satelliteIconをuseEffectの依存配列から削除
2. satelliteIconの初期化をuseRefを使用して一度だけ実行するように変更

```tsx
// 修正例
const satelliteIconRef = useRef<L.Icon | null>(null);

// 衛星アイコンの初期化（一度だけ作成）
if (!satelliteIconRef.current) {
  satelliteIconRef.current = L.icon({
    iconUrl: '/satellite.svg',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12],
    className: 'satellite-icon-blue'
  });
}
```

### 2. Content Security Policy (CSP) 制約エラー

アイコンの表示に関して以下のCSPエラーが発生しました：

```
Refused to load the image 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png' because it violates the following Content Security Policy directive: "img-src 'self' data: https://*.tile.openstreetmap.org".
```

このエラーは、外部サイト（unpkg.com）からの画像の読み込みがCSPによってブロックされていることを示しています。

#### 修正方針
アイコンをデータURL形式で埋め込むことでCSP制約を回避：

```tsx
iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjMTk3NmQyIi8+PHBhdGggZD0iTTEyLDYuNWMwLTEuMSwwLjktMiwyLTJzMiwwLjksMiwycy0wLjksMi0yLDJTMTIsNy42LDEyLDYuNXogTTE3LDguNWwzLDNsLTEuNSwxLjVsLTMtM1Y4LjV6IE03LDguNWwtMywzbDEuNSwxLjVsMy0zVjguNXogTTEyLDExLjVjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzEzLjEsMTEuNSwxMiwxMS41eiBNMTIsMTUuNWMtMS4xLDAtMiwwLjktMiwyczAuOSwyLDIsMnMyLTAuOSwyLTJTMTMuMSwxNS41LDEyLDE1LjV6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==',
```

これらのエラーは衛星情報パネルのタブ化とは直接関係ありませんが、アプリケーション全体の安定性と正常な動作のために修正が必要でした。

### 3. パフォーマンス警告

アプリケーション実行中に以下の警告が多数表示されています：

```
[Violation] 'message' handler took <N>ms
```

この警告は、JavaScriptのメインスレッドで長時間実行される処理があることを示しています。特にアニメーション中に頻繁に発生する可能性があります。

#### 考えられる原因
1. `findOrbitPoint`関数の計算コストが高い
2. アニメーション中の頻繁な再レンダリング
3. 経度の正規化処理（while文）の非効率性

#### 修正方針
1. `findOrbitPoint`関数をメモ化して、同じ入力に対して再計算を避ける
2. 経度の正規化処理を改善する（while文ではなく剰余演算を使用）
3. アニメーションの更新頻度を制限する（requestAnimationFrameやデバウンスの使用）

```tsx
// 経度の正規化処理の改善例
const normalizeLongitude = (lng: number): number => {
  return ((lng + 180) % 360 + 360) % 360 - 180;
};

// メモ化の例
const memoizedFindOrbitPoint = useMemo(() => {
  return findOrbitPoint(currentTime);
}, [currentTime, path]);
```

このパフォーマンス最適化は今後の課題として検討します。

## スクリーンショット
（実際の画面のスクリーンショットがあれば添付）
