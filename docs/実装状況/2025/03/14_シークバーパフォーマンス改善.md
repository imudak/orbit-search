# シークバーパフォーマンス改善

## 概要

軌道アニメーションのシークバーを操作した際のパフォーマンス問題を解決しました。シークバーを動かすたびに軌道の再計算と再描画が行われていたため、操作が重くなっていました。

## 問題点

1. シークバーを動かすたびに`animationState.currentTime`が更新され、以下のコンポーネントが再レンダリングされていた：
   - SatelliteOrbitLayer（衛星軌道レイヤー）
   - SunOrbitLayer（太陽軌道レイヤー）
   - SunPositionLayer（太陽位置レイヤー）

2. 特にSatelliteOrbitLayerでは、時間が変わるたびに多数の軌道ポイントに対して昼夜判定や描画処理が行われていた。

## 実装した改善策

1. **デバウンス処理の導入**：
   - シークバーをドラッグしている間は内部状態（`localTime`）のみを更新
   - 実際の時間（`currentTime`）はドラッグ終了時にのみ更新
   - これにより、ドラッグ中の頻繁な軌道再計算と再描画を防止

2. **視覚的フィードバックの維持**：
   - ドラッグ中でも時間表示は`localTime`に基づいて更新
   - スライダーの動きも`localTime`に連動

## 技術的な実装

`src/components/Map/panels/OrbitControlPanel.tsx`に以下の変更を実装：

1. `localTime`状態変数を追加して、ドラッグ中の一時的な時間を管理
```tsx
const [localTime, setLocalTime] = useState<Date>(currentTime);

// currentTimeが変更されたらlocalTimeも更新
useEffect(() => {
  setLocalTime(currentTime);
}, [currentTime]);
```

2. スライダーの`onChange`イベントでは`localTime`のみを更新
```tsx
onChange={(_, value) => {
  // スライダードラッグ中は内部状態のみを更新
  setLocalTime(new Date(value as number));
}}
```

3. スライダーの`onChangeCommitted`イベント（ドラッグ終了時）で実際の`currentTime`を更新
```tsx
onChangeCommitted={(_, value) => {
  // スライダードラッグ終了時に実際の時間を更新
  onSeek(new Date(value as number));
}}
```

4. 表示要素を`localTime`に連動
```tsx
<TextField
  fullWidth
  size="small"
  value={formatDate(localTime) + " " + formatTime(localTime)}
  sx={{ mb: 1 }}
  InputProps={{
    readOnly: true,
  }}
/>
<Typography variant="caption" sx={{ display: 'block', mb: 1, color: 'text.secondary' }}>
  UTC: {localTime.toISOString().substring(0, 16).replace('T', ' ')}
</Typography>
```

## 効果

- シークバーをドラッグしている間は軌道の再計算と再描画が行われなくなり、操作がスムーズになった
- ドラッグを終了した時点で初めて軌道の更新が行われるため、システムリソースの使用が最適化された
- ユーザーエクスペリエンスが向上し、特に低スペックのデバイスでも快適に操作できるようになった

## 今後の課題

- 他の重い処理（例：軌道計算）についても最適化を検討する
- アニメーション更新間隔のさらなる調整を検討する
