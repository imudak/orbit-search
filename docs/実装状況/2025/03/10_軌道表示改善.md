# 軌道表示改善レポート

## 概要

衛星の軌道表示に関する問題を修正しました。具体的には、仰角（elevation）がマイナスの場合（地平線の下にある場合）でも観測地点近くを軌道が通過してアニメーションされるという不具合を解消しました。

修正内容：
1. 仰角がマイナスの場合の軌道表示ロジックを改善
2. 実効的な角度（effectiveAngle）の計算方法を変更
3. 地平線の下にある衛星の表示方法を最適化

## 変更内容

### 問題の説明

衛星の軌道表示において、以下の問題が発生していました：

- 仰角がマイナスの場合（地平線の下にある場合）でも、観測地点近くを軌道が通過して表示されていた
- 実際には観測地点から見えない（地平線の下にある）衛星が、あたかも近くにあるように表示されていた
- 仰角と地図上の表示位置の関係が直感的でなかった

この問題は、`effectiveAngle`（実効的な角度）の計算方法に起因していました。従来の計算方法では、仰角がマイナスでも観測地点からの距離が近い場合、`effectiveAngle`の値が大きくなり、結果として観測地点近くに表示されていました。

### 修正内容

`orbitWorker.ts`の`effectiveAngle`計算ロジックを変更し、仰角がマイナスの場合は観測地点から遠くに表示されるようにしました：

```typescript
// 修正前
const distanceFactor = Math.max(0, 1 - greatCircleDistance / 90);
const effectiveAngle = elevation * distanceFactor;

// 修正後
const distanceFactor = Math.max(0, 1 - greatCircleDistance / 90);
// 仰角がマイナスの場合（地平線の下にある場合）は、
// 観測地点から遠くに表示されるように非常に小さな値を設定
const effectiveAngle = elevation >= 0
  ? elevation * distanceFactor
  : elevation * 0.01; // 仰角がマイナスの場合は非常に小さな係数を掛ける
```

この修正により：
- 仰角が0以上（地平線上または上）の場合：従来通りの計算方法を使用
- 仰角が0未満（地平線下）の場合：非常に小さな係数（0.01）を掛けることで、観測地点から遠くに表示されるようにした

### 表示への影響

この変更は、`SatelliteOrbitLayer`と`SatelliteAnimationLayer`の表示に影響します：

- `SatelliteOrbitLayer`では、仰角がマイナスの部分の軌道は最も薄い色（グレー）、最も細い線、最も低い透明度で表示される
- `SatelliteAnimationLayer`では、仰角がマイナスの場合、衛星は観測地点から遠くに表示される

## 改善効果

1. **視覚的な正確性の向上**
   - 仰角がマイナスの場合（地平線の下にある場合）、衛星は観測地点から遠くに表示されるようになり、実際の見え方と一致するようになった
   - 地平線の上下で軌道の表示が明確に区別されるようになった

2. **ユーザー体験の改善**
   - 衛星の可視/不可視状態が視覚的に明確になり、ユーザーが直感的に理解しやすくなった
   - 仰角がマイナスの部分は薄く表示されるため、重要な情報（可視部分）に集中しやすくなった

3. **データの一貫性**
   - 衛星は常に地図上のどこかに表示されるため、どの時点でも衛星の位置を確認できる
   - 仰角データと視覚表現の整合性が向上した

## 今後の課題

1. 軌道表示のさらなる最適化（特に極域や日付変更線付近での表示）
2. 仰角に基づく色分けや表示方法のカスタマイズ機能
3. 地平線の可視化機能の追加
4. 複数衛星の軌道が重なる場合の表示改善

## まとめ

今回の修正により、衛星の軌道表示がより直感的かつ正確になりました。特に、仰角がマイナスの場合（地平線の下にある場合）の表示が改善され、ユーザーは衛星の可視/不可視状態を視覚的に理解しやすくなりました。この改善は、衛星追跡や観測計画の立案において重要な役割を果たすと考えられます。
