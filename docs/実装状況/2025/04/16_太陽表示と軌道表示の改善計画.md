# 太陽表示と軌道表示の改善計画

## 日付: 2025/04/16

## 担当者: Kazumi Okano

## 1. 現状の問題点

### 軌道表示の滑らかさの問題
- 軌道表示がカクカクしており、滑らかな表示になっていない
- メモリと表示速度の最適化のために計算間隔を広く（5°～15°）設定している
- 特にズームレベルが低い場合、点の間隔が15°と広くなりすぎている

### 昼間エリアの表示の問題
- 明らかに夜間の時間帯なのに、観測地点が昼間のエリア（黄色の帯）に含まれている
- 単純に太陽の経度から東西に90度を昼間としているため、地球の傾きや季節による昼夜の変化が正確に反映されていない
- 昼夜の境界（ターミネーター）の計算に精度の問題がある

## 2. 改善計画

### 軌道表示の滑らかさ改善
1. **点の間隔を細かくする**
   - 現在のズーム別の点の間隔（5°～15°）を全体的に10倍細かくする
   - 0.5°～1.5°の間隔で点を生成する
   - ズームレベルに基づく動的調整は維持

2. **パフォーマンス対策**
   - 点数が増えるため、以下の対策を実施:
     - 画面外の点は描画しない最適化を強化
     - ポリゴンの描画を効率化（WebGLレンダリングの検討）
     - 計算結果をキャッシュして再利用
   - メモリ使用量のモニタリングを強化

### 昼夜エリア表示の改善
1. **昼夜境界の計算精度向上**
   - 現在の単純な計算（太陽経度±90°）から、地球の傾きを考慮した計算に変更
   - 太陽の赤緯（季節による変化）を計算に反映
   - 観測地点の緯度に基づいた昼夜判定を実装

2. **太陽位置計算の改善**
   - より正確な天文アルゴリズムを導入
   - 地球の楕円軌道の影響を考慮
   - 計算結果の検証機能を追加

## 3. 実装手順

### フェーズ1: コード調査と検証
- 現在の実装の詳細な調査
- 問題の正確な原因特定
- 改善方法の検証とテスト

### フェーズ2: 昼夜表示の改善
- sunCalculations.tsの改善
  - 太陽位置計算の精度向上
  - 昼夜境界線計算のロジック修正
- SunOrbitLayer.tsxの修正
  - 新しい計算ロジックの適用
  - 検証機能の追加

### フェーズ3: 軌道表示の滑らかさ改善
- SunOrbitLayer.tsxとSunPositionLayer.tsxの修正
  - 点の間隔を細かく設定
  - パフォーマンス最適化の実装
- アニメーションの改善
  - スムーズさとパフォーマンスのバランス調整

### フェーズ4: テストと最適化
- 改善効果の検証
- パフォーマンス測定
- 必要に応じて追加調整

## 4. 期待される効果
- 軌道表示が滑らかになり、視覚的に優れた表示になる
- 昼夜の境界線と領域が正確に表示される
- 観測地点の昼夜判定が正確になる

## 5. リスクと対策
- **メモリ使用量の増加**
  - 対策: ポイント数増加に伴うメモリ使用量を監視し、必要に応じて動的に調整
- **処理速度の低下**
  - 対策: WebGLの活用やレンダリング最適化で対応
- **モバイルデバイスでのパフォーマンス**
  - 対策: デバイス性能に応じた動的な品質調整機能の検討
