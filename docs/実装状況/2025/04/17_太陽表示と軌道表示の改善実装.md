# 太陽表示と軌道表示の改善実装

## 日付: 2025/04/17

## 担当者: Kazumi Okano

## 1. 実装項目

### 完了した実装
- ✅ 軌道表示を滑らかにするための点間隔の最適化（10倍の精度）
- ✅ 太陽の昼夜境界表示の精度向上
- ✅ 太陽位置計算アルゴリズムの改善
- ✅ パフォーマンスを維持するためのキャッシュとレンダリング最適化
- ✅ 軌道の昼夜表示（実線/点線）と昼夜領域表示の一致

### 課題と解決策
- ❌ 軌道表示がカクカクして不自然 → 点の間隔を10倍細かく設定して解決
- ❌ 明らかに夜間なのに昼間エリアとして表示される問題 → 太陽の経度計算アルゴリズムを修正して解決
- ❌ 軌道上の実線/点線表示と昼間領域表示にずれがある → isDaylight関数を統一して解決

## 2. 実装の詳細

### 軌道表示の滑らかさ改善
- **点の間隔の最適化**
  - 従来: 5°～15°（ズームレベルによる）
  - 改善後: 0.5°～1.5°（10倍の精度）
  - ズームレベルに応じた動的調整は維持

- **パフォーマンス対策**
  - キャッシュ機構の導入による再計算の最小化
  - Canvasレンダラーの活用による描画の効率化
  - 画面外のポイントのレンダリングをスキップする最適化

### 太陽位置と昼夜境界の精度向上
- **天文アルゴリズムの改善**
  - 太陽の赤緯計算を高精度化
  - 2000年1月1日を基準とするエポック計算に変更
  - 地球の楕円軌道と軸の傾きを考慮

- **昼夜境界線（ターミネーター）の計算精度向上**
  - 昼夜の境界を高精度なターミネーター計算に基づいて生成
  - 太陽の赤緯を考慮した日の出・日の入り境界線の計算
  - 極地における昼夜判定の精度向上

- **太陽経度計算の修正**
  - UTCと太陽位置の関係を正確に表現
  - 「UTC 0時では太陽は経度180度付近」という正しいモデルに修正
  - 結果、日本時間深夜に東アジアが正しく夜間として表示される

### 軌道の昼夜表示の一致
- **昼夜判定の統一**
  - 太陽位置計算と軌道表示の昼夜判定を同じロジックに統一
  - SatelliteOrbitLayerでsunCalculations.tsのisDaylight関数を直接使用
  - 実線（昼間）と点線（夜間）の表示が昼夜領域と正確に一致

## 3. 実装したファイル
- `src/utils/sunCalculations.ts`: 太陽計算のユーティリティ関数を改善
- `src/components/Map/layers/SunOrbitLayer.tsx`: 昼夜の境界線と昼間の領域表示を改善
- `src/components/Map/layers/SunPositionLayer.tsx`: 太陽位置のアイコン表示を改善
- `src/components/Map/layers/SatelliteOrbitLayer.tsx`: 軌道の昼夜表示（実線/点線）を修正

## 4. 技術的な改善点

### 精度向上
- 太陽の赤緯と経度の計算に高精度な天文アルゴリズムを導入
- 昼夜の境界線（ターミネーター）計算を季節変化に対応
- 極地における白夜/極夜の適切な処理
- 軌道の昼夜表示と昼夜領域表示の一貫性確保

### パフォーマンス最適化
- キャッシュ機構の導入による計算回数の削減
- レンダリングの効率化（Canvasレンダラーの活用）
- 不要な再レンダリングの防止

### ユーザー体験向上
- より滑らかな軌道表示によるビジュアル改善
- 正確な昼夜表示による状況理解の向上
- アニメーション更新頻度の増加（2秒→0.2秒）
- 軌道の実線（昼間）/点線（夜間）表示が直感的に理解しやすく

## 5. 残課題と今後の対応

### 今後の対応
- モバイルデバイスでのパフォーマンス最適化
- より多くの衛星を同時表示した場合のメモリ使用量監視
- 日の出/日の入り時刻の表示機能の追加検討
- 極地近くでの昼夜表示の精度をさらに向上

## 6. 参考資料
- 天文アルゴリズム: Meeus, Jean. "Astronomical Algorithms"
- 昼夜の境界線計算: NOAA Solar Position Calculator
- 地球の自転と太陽位置の関係: NASA Sun-Earth Day
